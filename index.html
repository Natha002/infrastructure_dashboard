<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered KeNHA Infrastructure Dashboard (Western)</title>
    <!-- Favicon (optional but nice touch) -->
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/KeNHA_Logo.svg/1200px-KeNHA_Logo.svg.png" type="image/png">

    <style>
        /* General Body Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        /* Header Styles */
        header {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 10px; /* Add some space for wrapping */
        }

        .logo img {
            height: 50px;
            margin-right: 15px;
        }

        .logo h1 {
            margin: 0;
            font-size: 1.8em;
            color: #0056b3; /* KeNHA blue */
        }

        /* Toggle Buttons and Top Home Button Container */
        .header-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px; /* Space between toggles and new button */
        }

        .toggle-container {
            display: flex;
            background-color: #e0e0e0;
            border-radius: 25px;
            overflow: hidden;
        }

        .toggle-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #555;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .toggle-button.active {
            background-color: #ffc107; /* Yellow theme for public */
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Updated style for staff/admin button */
        #staffAdminToggle {
            background-color: #0056b3; /* Blue theme for staff */
            color: #fff;
        }
        #staffAdminToggle:hover {
            background-color: #004085;
        }


        /* New Top Home Button Style */
        #goBackHomeTopBtn {
            padding: 10px 20px;
            border: none;
            background-color: #6c757d; /* Grey for "back" */
            color: white;
            border-radius: 25px; /* Same rounded as toggles */
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease, visibility 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0; /* Hidden by default */
            visibility: hidden; /* Hidden from interaction */
        }

        #goBackHomeTopBtn.visible {
            opacity: 1;
            visibility: visible;
        }

        #goBackHomeTopBtn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        #goBackHomeTopBtn:active {
            background-color: #495057;
            transform: translateY(0);
        }

        /* Main Content Area */
        main {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        main h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
        }

        main p {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea,
        select {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 12px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="file"] {
            padding: 10px 0;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        button[type="submit"] {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background-color: #28a745; /* Green for submit */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button[type="submit"]:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        button[type="submit"]:active {
            background-color: #1e7e34;
            transform: translateY(0);
        }

        /* Loading Spinner */
        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 30px;
            text-align: center;
            min-height: 200px; /* Give it some height even when hidden */
            opacity: 0; /* Start invisible */
            visibility: hidden; /* Hide from screen readers and pointer events */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .spinner-container.visible {
            opacity: 1; /* Fade in */
            visibility: visible; /* Make visible */
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff; /* Blue spinner */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Thank You Section */
        #thankYouSection {
            margin-top: 40px;
            padding: 30px;
            background-color: #e9f7ef; /* Light green background */
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            text-align: center;
            opacity: 0; /* Start hidden */
            visibility: hidden; /* New: Hide from screen readers and pointer events */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; /* Smooth fade in */
        }

        #thankYouSection.visible {
            opacity: 1; /* Make visible */
            visibility: visible; /* New: Make visible */
        }

        #thankYouSection h3 {
            color: #28a745;
            font-size: 2.2em;
            margin-bottom: 15px;
        }

        #thankYouSection p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 30px;
        }

        /* Button to go back home/submit another report (bottom one) */
        .go-back-btn {
            background-color: #007bff; /* Blue */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 25px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .go-back-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .go-back-btn:active {
            background-color: #004085;
            transform: translateY(0);
        }

        /* Using display: none for elements that should completely disappear */
        .hidden {
            display: none !important;
        }

        /* New class to hide the form container */
        #reportFormContainer {
            opacity: 1; /* Start visible */
            height: auto; /* Start auto height */
            overflow: visible; /* Start visible overflow */
            transition: opacity 0.5s ease-out, height 0.5s ease-out;
        }

        #reportFormContainer.form-hidden {
            opacity: 0;
            height: 0; /* Collapse height */
            margin-bottom: 0;
            padding: 0;
            overflow: hidden; /* Hide content that overflows collapsed height */
        }

        /* NEW: Map container styling */
        .map-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px; /* Space below map */
            text-align: center; /* For the h4 inside */
        }

        .map-container h4 {
            color: #0056b3;
            font-size: 1.6em;
            margin-bottom: 15px;
        }

        /* Ensure map div itself has border radius */
        #defectMap {
            border-radius: 8px;
            overflow: hidden; /* Important for border-radius to work on the map content */
        }


        /* Snapshot Analysis Section */
        #snapshotAnalysis {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }

        #snapshotAnalysis h4 {
            color: #0056b3;
            font-size: 1.6em;
            margin-bottom: 25px;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            flex: 1;
            min-width: 180px;
            max-width: 45%;
            text-align: center;
            /* Ensure responsiveness on smaller screens */
            box-sizing: border-box; /* Include padding in width calculations */
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #007bff;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #777;
        }

        .chart-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            max-width: 500px; /* Keep max width */
            margin: 0 auto 30px auto;
            /* Added for Chart.js responsiveness */
            position: relative; /* Important for chart responsiveness */
            height: 300px; /* Give it a default height, Chart.js will adjust */
        }

        .data-last-updated {
            font-size: 0.85em;
            color: #888;
            margin-top: 20px;
        }

        /* Image Upload Progress */
        .upload-progress {
            width: 100%;
            height: 5px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .upload-progress::after {
            content: '';
            display: block;
            height: 100%;
            width: 0;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        .upload-success {
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        /* Custom Alert Message Styling */
        #customAlert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745; /* Green for success */
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            font-size: 1.1em;
            text-align: center;
        }

        #customAlert.visible {
            opacity: 1;
        }

        #customAlert.error {
            background-color: #dc3545; /* Red for error */
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                flex-direction: column; /* Stack toggles and home button vertically */
                width: 100%; /* Take full width */
                align-items: flex-start; /* Align left */
            }

            .toggle-container {
                width: 100%;
                margin-bottom: 10px; /* Space between toggle and new home button */
            }

            .toggle-button {
                flex: 1;
                text-align: center;
            }

            #goBackHomeTopBtn {
                width: 100%; /* Full width on small screens */
            }

            .logo h1 {
                font-size: 1.5em;
            }

            main {
                margin: 20px;
                padding: 20px;
            }

            .stat-box {
                max-width: 100%; /* Ensure stat boxes stack on very small screens */
                flex-basis: 100%; /* Each takes full width */
            }

            .stats-container {
                flex-direction: column; /* Stack vertically on small screens */
            }

            /* Ensure chart is visible and responsive */
            .chart-container {
                max-width: 100%; /* Allow chart to use full width */
                height: 250px; /* Adjust height for mobile */
            }

            /* NEW: Map container on mobile */
            .map-container {
                max-width: 100%;
                padding: 15px; /* Slightly less padding on mobile */
            }

            #defectMap {
                height: 250px; /* Adjust height for mobile maps */
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/KeNHA_Logo.svg/1200px-KeNHA_Logo.svg.png" alt="KeNHA Logo">
            <h1>AI-Powered Infrastructure Dashboard for KeNHA (Western)</h1>
        </div>
        <div class="header-controls">
            <div class="toggle-container">
                <button id="publicToggle" class="toggle-button active">Public Report</button>
                <!-- Renamed staffToggle to staffAdminToggle -->
                <button id="staffAdminToggle" class="toggle-button">KeNHA Staff / Admin</button>
            </div>
            <button id="goBackHomeTopBtn">Go Back Home</button>
        </div>
    </header>

    <main id="publicReportSection">
        <div id="reportFormContainer">
            <h2>Submit Road Defect Report</h2>
            <p>Fill in the details below to submit an inspection report.</p>
            <form id="defectReportForm">
                <div class="form-group">
                    <label for="userId">Your User ID (Optional for Public):</label>
                    <input type="text" id="userId" name="userId" placeholder="Enter your ID or name">
                </div>

                <div class="form-group">
                    <label for="defectType">Defect Type:</label>
                    <select id="defectType" name="defectType" required>
                        <option value="">Select a defect type</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Crack">Crack</option>
                        <option value="Culvert Blockage">Culvert Blockage</option>
                        <option value="Shoulder Erosion">Shoulder Erosion</option>
                        <option value="Bridge Damage">Bridge Damage</option>
                        <option value="Vegetation Overgrowth">Vegetation Overgrowth</option>
                        <option value="Illegal Signpost">Illegal Signpost</option>
                        <option value="Encroachment">Encroachment into Road Reserve</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="severityLevel">Severity Level (AI-Suggested or Manual):</label>
                    <select id="severityLevel" name="severityLevel" required>
                        <option value="">Select severity</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kilometerPost">Kilometer Post (e.g., KM 2+500) / Landmark:</label>
                    <input type="text" id="kilometerPost" name="kilometerPost" placeholder="e.g., KM 2+500 or Near Odienya Stream" required>
                </div>

                <div class="form-group">
                    <label for="currentLocation">Current Location (GPS):</label>
                    <button type="button" id="getLocationBtn" class="go-back-btn" style="background-color: #17a2b8; margin-top: 5px;">Get My Current Location</button>
                    <input type="text" id="latitudeInput" name="latitude" placeholder="Latitude" readonly style="margin-top: 10px;">
                    <input type="text" id="longitudeInput" name="longitude" placeholder="Longitude" readonly style="margin-top: 10px;">
                    <small id="locationStatus" style="display: block; margin-top: 5px; color: #666;">Click "Get My Current Location" to get coordinates.</small>
                </div>

                <div class="form-group">
                    <label for="assetId">Asset ID (for Culverts/Bridges), e.g., C27-CULV-003 (Optional):</label>
                    <input type="text" id="assetId" name="assetId" placeholder="e.g., C27-CULV-003">
                </div>

                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" rows="4" placeholder="Enter defect details here, e.g., 'Large pothole causing traffic swerving near Odienya stream.'" required></textarea>
                </div>

                <div class="form-group">
                    <label for="imageUpload">Upload Image (Optional):</label>
                    <input type="file" id="imageUpload" name="imageUpload" accept="image/*">
                    <div id="imageUploadProgress" class="upload-progress"></div>
                    <div id="imageUploadSuccess" class="upload-success"></div>
                </div>

                <div class="form-group">
                    <label for="assignedTeam">Assigned Team/Contractor (Optional - for Staff):</label>
                    <input type="text" id="assignedTeam" name="assignedTeam" placeholder="e.g., Maintenance Team A or XYZ Contractors">
                </div>

                <button type="submit">Submit Inspection Report</button>
            </form>
        </div>

        <div id="loadingSpinner" class="spinner-container">
            <div class="spinner"></div>
            <p>Processing your report...</p>
        </div>

        <div id="customAlert" class="hidden"></div>


        <div id="thankYouSection">
            <h3>Thank you for your input! ðŸ‘‹</h3>
            <p>See the collective impact of community reports on the monitored infrastructure.</p>

            <div class="map-container">
                <h4>Defect Location</h4>
                <div id="defectMap" style="height: 350px; width: 100%; border-radius: 8px; margin-top: 15px;"></div>
                <p id="mapLocationDetails" style="margin-top: 10px; font-style: italic; color: #777;"></p>
            </div>

            <div id="snapshotAnalysis">
                <h4>Snapshot Analysis: C27 Kisumuâ€“Bondo Road</h4>
                <div class="stats-container">
                    <div class="stat-box">
                        <span class="stat-value" id="totalActiveReports">0</span>
                        <span class="stat-label">Total Active Reports</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="criticalIssuesToday">0</span>
                        <span class="stat-label">Critical Issues Reported Today</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="defectsByTypeChart"></canvas>
                </div>
                <p class="data-last-updated">Data last updated: <span id="lastUpdatedTimestamp"></span></p>
            </div>
            <button id="goBackHomeBtn" class="go-back-btn">Submit Another Report</button>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOQx1j1rOe2xQr7GPWgk7tj7V7pM3jfsI", // Replace with your Firebase project API Key
            authDomain: "kenha-dashboard3.firebaseapp.com",
            projectId: "kenha-dashboard3",
            storageBucket: "kenha-dashboard3.firebasestorage.app",
            messagingSenderId: "62179733586",
            appId: "1:62179733586:web:4cc76ec2895d920dcdaf8b",
            measurementId: "G-14YP9TLY05"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // --- DOM Elements ---
        const reportFormContainer = document.getElementById('reportFormContainer');
        const defectReportForm = document.getElementById('defectReportForm');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const thankYouSection = document.getElementById('thankYouSection');
        const publicToggle = document.getElementById('publicToggle');
        // Renamed staffToggle to staffAdminToggle
        const staffAdminToggle = document.getElementById('staffAdminToggle');
        const goBackHomeTopBtn = document.getElementById('goBackHomeTopBtn');
        const imageUploadInput = document.getElementById('imageUpload');
        const imageUploadProgress = document.getElementById('imageUploadProgress');
        const imageUploadSuccess = document.getElementById('imageUploadSuccess');
        const submitButton = defectReportForm.querySelector('button[type="submit"]');
        const customAlert = document.getElementById('customAlert');
        const goBackHomeBtn = document.getElementById('goBackHomeBtn');

        const getLocationBtn = document.getElementById('getLocationBtn');
        const latitudeInput = document.getElementById('latitudeInput');
        const longitudeInput = document.getElementById('longitudeInput');
        const locationStatus = document.getElementById('locationStatus');
        const defectMapDiv = document.getElementById('defectMap');
        const mapLocationDetails = document.getElementById('mapLocationDetails');

        // --- Google Maps API Key (IMPORTANT: Replace with your actual key) ---
        const GOOGLE_MAPS_API_KEY = "AIzaSyBO6Ru9uIEdIyUI6Rq3qmlEr6rxuNRemw8"; // <<< REPLACE THIS WITH YOUR GOOGLE MAPS API KEY!!!

        let currentMap = null;

        const totalActiveReportsSpan = document.getElementById('totalActiveReports');
        const criticalIssuesTodaySpan = document.getElementById('criticalIssuesToday');
        const defectsByTypeChartCtx = document.getElementById('defectsByTypeChart').getContext('2d');
        const lastUpdatedTimestampSpan = document.getElementById('lastUpdatedTimestamp');

        let defectsByTypeChart;

        // --- Utility Functions ---
        function showAlert(message, type = 'success', duration = 2000) {
            customAlert.textContent = message;
            customAlert.className = '';
            customAlert.classList.add(type === 'error' ? 'error' : 'success');
            customAlert.classList.add('visible');

            setTimeout(() => {
                customAlert.classList.remove('visible');
                setTimeout(() => {
                    customAlert.classList.add('hidden');
                }, 500);
            }, duration);
        }

        // --- Navigation Control Function ---
        function showForm() {
            thankYouSection.classList.remove('visible');
            goBackHomeTopBtn.classList.remove('visible');
            setTimeout(() => {
                thankYouSection.classList.add('hidden');
                goBackHomeTopBtn.classList.add('hidden');
            }, 500);

            reportFormContainer.classList.remove('hidden');
            setTimeout(() => {
                reportFormContainer.classList.remove('form-hidden');
                reportFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
        }

        function showDashboard() {
            reportFormContainer.classList.add('form-hidden');
            setTimeout(() => {
                reportFormContainer.classList.add('hidden');
            }, 500);

            loadingSpinner.classList.remove('hidden');
            loadingSpinner.classList.add('visible');
            loadingSpinner.scrollIntoView({ behavior: 'smooth', block: 'center' });

            thankYouSection.classList.remove('hidden');
            thankYouSection.classList.remove('visible');

            goBackHomeTopBtn.classList.remove('hidden');
            goBackHomeTopBtn.classList.remove('visible');

            loadGoogleMapsScript(() => {
                console.log("Google Maps API loaded.");
            });
        }

        // --- Geolocation Functionality ---
        getLocationBtn.addEventListener('click', () => {
            locationStatus.textContent = 'Getting location...';
            locationStatus.style.color = '#007bff';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        latitudeInput.value = lat.toFixed(6);
                        longitudeInput.value = lng.toFixed(6);
                        locationStatus.textContent = 'Location acquired! âœ…';
                        locationStatus.style.color = '#28a745';
                        showAlert('Location acquired!', 'success', 1500);
                    },
                    (error) => {
                        let errorMessage;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Location permission denied. Please enable it in your browser settings.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information is unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "The request to get user location timed out.";
                                break;
                            default:
                                errorMessage = "An unknown error occurred while getting location.";
                                break;
                        }
                        locationStatus.textContent = `Error: ${errorMessage}`;
                        locationStatus.style.color = '#dc3545';
                        showAlert(`Location error: ${errorMessage}`, 'error', 3000);
                        console.error("Geolocation error:", error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                locationStatus.textContent = 'Geolocation is not supported by your browser.';
                locationStatus.style.color = '#dc3545';
                showAlert('Geolocation not supported by this browser.', 'error', 3000);
            }
        });


        // --- Google Maps Integration ---
        function loadGoogleMapsScript(callback) {
            if (window.google && window.google.maps) {
                callback();
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMapPlaceholder`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            window.initMapPlaceholder = callback;
        }

        function displayDefectMap(lat, lng) {
            if (!lat || !lng) {
                defectMapDiv.innerHTML = "<p>No location data available for this report.</p>";
                mapLocationDetails.textContent = "Location not captured.";
                return;
            }

            const mapOptions = {
                center: { lat: lat, lng: lng },
                zoom: 15,
                mapTypeId: 'roadmap',
                fullscreenControl: false,
                streetViewControl: false,
                mapTypeControl: false,
                zoomControl: true,
            };

            if (currentMap) {
                currentMap.setCenter(mapOptions.center);
                currentMap.setZoom(mapOptions.zoom);
                currentMap.marker.setPosition(mapOptions.center);
            } else {
                currentMap = new google.maps.Map(defectMapDiv, mapOptions);
                currentMap.marker = new google.maps.Marker({
                    position: mapOptions.center,
                    map: currentMap,
                    title: 'Defect Location',
                    animation: google.maps.Animation.DROP,
                });
            }

            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'location': { lat: lat, lng: lng } }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    mapLocationDetails.textContent = `Location: ${results[0].formatted_address}`;
                } else {
                    mapLocationDetails.textContent = `Location: Latitude ${lat.toFixed(6)}, Longitude ${lng.toFixed(6)}`;
                    console.warn('Geocoder failed due to: ' + status);
                }
            });
        }


        // --- Event Listeners ---

        publicToggle.addEventListener('click', () => {
            publicToggle.classList.add('active');
            staffAdminToggle.classList.remove('active'); // Ensure staff button is not active
            showForm();
        });

        // Updated staffAdminToggle to redirect to admin.html
        staffAdminToggle.addEventListener('click', () => {
            // Instead of an alert, redirect to the admin dashboard page
            window.location.href = 'admin.html';
        });

        imageUploadInput.addEventListener('change', async () => {
            const imageFile = imageUploadInput.files[0];
            if (imageFile) {
                imageUploadProgress.style.width = '0%';
                imageUploadSuccess.style.display = 'none';

                submitButton.disabled = true;
                submitButton.textContent = 'Uploading Image...';

                const storageRef = storage.ref();
                const imageRef = storageRef.child(`images/${Date.now()}_${imageFile.name}`);
                const uploadTask = imageRef.put(imageFile);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        imageUploadProgress.style.width = `${progress}%`;
                        console.log('Image upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.error("Image upload failed:", error);
                        showAlert("Image upload failed. Please try again. Check your Firebase Storage rules.", 'error');
                        imageUploadProgress.style.width = '0%';
                        imageUploadSuccess.style.display = 'none';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit Inspection Report';
                    },
                    async () => {
                        const imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                        imageUploadInput.dataset.imageUrl = imageUrl;
                        imageUploadSuccess.textContent = 'Upload successful! âœ…';
                        imageUploadSuccess.style.display = 'block';
                        imageUploadProgress.style.width = '100%';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit Inspection Report';
                        console.log('Image URL:', imageUrl);
                    }
                );
            } else {
                imageUploadInput.dataset.imageUrl = '';
                imageUploadProgress.style.width = '0%';
                imageUploadSuccess.style.display = 'none';
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Inspection Report';
            }
        });


        defectReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitButton.disabled = true;
            showDashboard();

            const formData = new FormData(defectReportForm);
            const reportData = {};
            for (let [key, value] of formData.entries()) {
                reportData[key] = value;
            }

            if (reportData.imageUpload) {
                delete reportData.imageUpload;
            }
            reportData.imageUrl = imageUploadInput.dataset.imageUrl || null;

            reportData.latitude = latitudeInput.value ? parseFloat(latitudeInput.value) : null;
            reportData.longitude = longitudeInput.value ? parseFloat(longitudeInput.value) : null;

            reportData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
            reportData.status = 'Reported';

            await saveReportToFirestore(reportData);
        });


        async function saveReportToFirestore(reportData) {
            try {
                const aiAnalysis = simulateAIAnalysis(reportData);
                reportData.aiSeverity = aiAnalysis.severity;
                reportData.aiRecommendation = aiAnalysis.recommendation;

                const querySnapshot = await db.collection('reports')
                    .where('description', '==', reportData.description)
                    .where('kilometerPost', '==', reportData.kilometerPost)
                    .limit(1)
                    .get();

                if (!querySnapshot.empty) {
                    showAlert('âš ï¸ This exact report seems to have been already entered. Thank you for your continued vigilance!', 'error', 3000); // Increased duration
                    loadingSpinner.classList.remove('visible');
                    loadingSpinner.classList.add('hidden'); // Ensure spinner is hidden
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Inspection Report';

                    // Delay returning to form to allow alert to be seen
                    setTimeout(() => {
                        showForm();
                    }, 3000); // Match or slightly exceed alert duration
                    return;
                }

                await db.collection('reports').add(reportData);

                showAlert('Report submitted successfully! ðŸŽ‰');

                loadingSpinner.classList.remove('visible');
                setTimeout(() => loadingSpinner.classList.add('hidden'), 300);

                defectReportForm.reset();
                imageUploadInput.dataset.imageUrl = '';
                imageUploadProgress.style.width = '0%';
                imageUploadSuccess.style.display = 'none';
                
                latitudeInput.value = '';
                longitudeInput.value = '';
                locationStatus.textContent = 'Click "Get My Current Location" to get coordinates.';
                locationStatus.style.color = '#666';


                setTimeout(() => {
                    thankYouSection.classList.add('visible');
                    thankYouSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    goBackHomeTopBtn.classList.add('visible');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Inspection Report';

                    displayDefectMap(reportData.latitude, reportData.longitude);

                }, 2000);

            } catch (e) {
                console.error("Error adding document: ", e);
                showAlert("An error occurred while submitting the report. Please try again.", 'error');

                loadingSpinner.classList.remove('visible');
                setTimeout(() => loadingSpinner.classList.add('hidden'), 300);

                showForm();

                imageUploadProgress.style.width = '0%';
                imageUploadSuccess.style.display = 'none';
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Inspection Report';
            }
        }

        goBackHomeBtn.addEventListener('click', showForm);
        goBackHomeTopBtn.addEventListener('click', showForm);


        // --- Real-time Data Visualization (Public View) ---
        db.collection('reports').orderBy('timestamp', 'desc')
            .onSnapshot((snapshot) => {
                const reports = [];
                snapshot.forEach(doc => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                updatePublicDashboard(reports);
            }, (error) => {
                console.error("Error fetching real-time reports:", error);
            });

        function updatePublicDashboard(reports) {
            let totalActive = reports.filter(r => r.status !== 'Resolved' && r.status !== 'Deferred').length;
            let criticalToday = reports.filter(r => r.aiSeverity === 'Critical' && r.timestamp && isToday(r.timestamp.toDate())).length;

            totalActiveReportsSpan.textContent = totalActive;
            criticalIssuesTodaySpan.textContent = criticalToday;
            lastUpdatedTimestampSpan.textContent = new Date().toLocaleString();

            const defectCounts = {};
            reports.forEach(report => {
                const type = report.defectType || 'Unknown';
                defectCounts[type] = (defectCounts[type] || 0) + 1;
            });

            const chartLabels = Object.keys(defectCounts);
            const chartData = Object.values(defectCounts);

            if (defectsByTypeChart) {
                defectsByTypeChart.data.labels = chartLabels;
                defectsByTypeChart.data.datasets[0].data = chartData;
                defectsByTypeChart.update();
            } else {
                defectsByTypeChart = new Chart(defectsByTypeChartCtx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9900', '#A52A2A', '#008000', '#6A5ACD', '#DAA520'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                align: 'center',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Defects by Type (Cumulative)',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed + ' reports (' + ((context.parsed / chartData.reduce((a,b)=>a+b,0)) * 100).toFixed(1) + '%)';
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function isToday(someDate) {
            if (!someDate) return false;
            const today = new Date();
            return someDate.getDate() === today.getDate() &&
                   someDate.getMonth() === today.getMonth() &&
                   someDate.getFullYear() === today.getFullYear();
        }

        function simulateAIAnalysis(report) {
            let severity = 'Medium';
            let recommendation = 'Standard maintenance required.';

            const lowerDescription = (report.description || '').toLowerCase();
            const lowerDefectType = (report.defectType || '').toLowerCase();

            if (lowerDescription.includes('large pothole') || lowerDescription.includes('collapsed culvert') || lowerDescription.includes('severe crack') || lowerDescription.includes('impassable') || lowerDescription.includes('accident prone')) {
                severity = 'Critical';
                recommendation = 'Immediate attention required: severe hazard, close section if necessary.';
            } else if (lowerDescription.includes('significant crack') || lowerDescription.includes('major blockage') || lowerDescription.includes('medium pothole') || lowerDescription.includes('dangerous')) {
                severity = 'High';
                recommendation = 'Urgent repair needed, schedule within 1-3 days.';
            } else if (lowerDescription.includes('small crack') || lowerDescription.includes('minor erosion') || lowerDescription.includes('bushes') || lowerDescription.includes('overgrowth')) {
                severity = 'Low';
                recommendation = 'Add to routine maintenance schedule.';
            }

            if (lowerDefectType === 'encroachment') {
                severity = 'High';
                recommendation = 'Notify legal and enforcement team for immediate action. Document thoroughly.';
            } else if (lowerDefectType === 'illegal signpost') {
                severity = 'Medium';
                recommendation = 'Dispatch team for signpost removal and fine assessment.';
            } else if (lowerDefectType === 'culvert blockage' && severity !== 'Critical') {
                severity = 'High';
                recommendation = 'Urgent clearing of debris to prevent flooding/road damage.';
            } else if (lowerDefectType === 'pothole' && severity === 'Medium') {
                recommendation = 'Patching required within a week.';
            } else if (lowerDefectType === 'shoulder erosion' && severity === 'Medium') {
                recommendation = 'Resurfacing or gabion placement recommended.';
            }

            if (report.severityLevel && ['Critical', 'High', 'Medium', 'Low'].includes(report.severityLevel)) {
                 severity = report.severityLevel;
            }

            return { severity, recommendation };
        }

        document.addEventListener('DOMContentLoaded', () => {
            showForm();

            loadingSpinner.classList.add('hidden');
            thankYouSection.classList.add('hidden');
            goBackHomeTopBtn.classList.add('hidden');
            customAlert.classList.add('hidden');

            publicToggle.classList.add('active');
            staffAdminToggle.classList.remove('active');
        });

    </script>
</body>
</html>
