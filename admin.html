<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff / Admin Dashboard</title>
    <link rel="icon" href="logo.png" type="image/png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        header {
            background-color: #0056b3; /* Blue for admin header */
            background-image: url('banner.jpg'); /* Thin strip banner image */
            background-size: cover; /* Cover the entire header area */
            background-position: center; /* Center the image */
            background-repeat: no-repeat; /* Do not repeat the image */
            padding: 10px 20px; /* Reduced padding for thin strip */
            min-height: 100px; /* Set a minimum height for the thin strip */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            color: white;
            position: relative; /* Needed for potential overlay if text is hard to read */
        }

        /* Optional: Add an overlay for better text readability on the banner */
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Semi-transparent overlay */
            z-index: 1;
        }

        .logo, .header-controls {
            z-index: 2; /* Ensure content is above the overlay */
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 0; /* No margin-bottom for a thin header */
        }

        .logo img {
            height: 50px;
            margin-right: 15px;
            /* Removed filter: invert(100%); as logo.png might be colored */
        }

        .logo h1 {
            margin: 0;
            font-size: 1.8em;
            color: white;
        }

        .header-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .back-to-public-btn {
            padding: 10px 20px;
            border: none;
            background-color: #ffc107; /* Yellow to stand out */
            color: #333;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .back-to-public-btn:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        main {
            max-width: 1200px; /* Wider for admin dashboard */
            margin: 30px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        main h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        /* Common dashboard elements */
        .dashboard-section {
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .dashboard-section h3 {
            color: #0056b3;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            text-align: center; /* Centered this heading */
            position: relative; /* For tooltip */
            cursor: help; /* Indicate hoverable */
        }

        /* Tooltip for H3 */
        .h3-tooltip {
            visibility: hidden;
            width: 250px; /* Wider for more descriptive text */
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 0;
            position: absolute;
            z-index: 1;
            bottom: 100%; /* Position above the heading */
            left: 50%;
            margin-left: -125px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.8em;
            white-space: normal;
        }

        .h3-tooltip::after {
            content: " ";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .dashboard-section h3:hover .h3-tooltip {
            visibility: visible;
            opacity: 1;
        }


        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            flex: 1;
            min-width: 180px;
            max-width: 30%; /* More boxes, smaller width */
            text-align: center;
            box-sizing: border-box;
            position: relative; /* Needed for tooltip positioning */
            cursor: help; /* Indicate hoverable */
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #007bff;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #777;
        }

        /* Tooltip styles for stat boxes */
        .stat-tooltip {
            visibility: hidden;
            width: 160px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 0;
            position: absolute;
            z-index: 1;
            bottom: 100%; /* Position above the stat box */
            left: 50%;
            margin-left: -80px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.8em;
            white-space: normal; /* Allow text to wrap */
        }

        .stat-tooltip::after {
            content: " ";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .stat-box:hover .stat-tooltip {
            visibility: visible;
            opacity: 1;
        }


        .chart-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            max-width: 600px; /* Chart can be wider here */
            margin: 0 auto 30px auto;
            position: relative;
            height: 400px; /* Increased height for admin charts */
        }

        .data-last-updated {
            font-size: 0.85em;
            color: #888;
            margin-top: 20px;
            text-align: center;
        }

        /* Map Container for Admin */
        .admin-map-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            text-align: center;
        }
        #adminDefectMap {
            height: 500px; /* Larger map for admin */
            width: 100%;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        /* Table Styles */
        .reports-table-container {
            overflow-x: auto; /* Allow horizontal scrolling on small screens */
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            background-color: #fff;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* Ensure table doesn't get too squished */
        }

        .reports-table th, .reports-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        .reports-table th {
            background-color: #e9eef5;
            color: #333;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .reports-table tr:hover {
            background-color: #f5f5f5;
        }

        .reports-table td img {
            max-width: 100px;
            max-height: 80px;
            border-radius: 4px;
            object-fit: cover;
            display: block;
            margin: 0 auto; /* Center image in cell */
        }

        .reports-table td.status-reported { color: #dc3545; font-weight: bold; } /* Red */
        .reports-table td.status-in-progress { color: #ffc107; font-weight: bold; } /* Yellow */
        .reports-table td.status-resolved { color: #28a745; font-weight: bold; } /* Green */
        .reports-table td.status-deferred { color: #6c757d; font-weight: bold; } /* Grey */

        /* Specific style for the status column to prevent wrapping and ensure visibility */
        .reports-table td:nth-child(9) { /* Assuming Status is the 9th column (index 8) */
            width: 150px; /* Increased width to ensure dropdown fits fully */
        }

        /* Inline editing styles (now only for Status) */
        .editable-select {
            width: 100%; /* Make select take full width of its cell */
            min-width: 100px; /* Ensure a minimum width for the select itself */
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .editable-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* Export Buttons */
        .export-buttons {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        .export-buttons button {
            padding: 12px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .export-buttons .export-csv-btn {
            background-color: #28a745; /* Green */
            color: white;
        }
        .export-buttons .export-csv-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .export-buttons .export-pdf-btn {
            background-color: #dc3545; /* Red */
            color: white;
        }
        .export-buttons .export-pdf-btn:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* PDF Generation Overlay */
        #pdfLoadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.5em;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #pdfLoadingOverlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #pdfLoadingOverlay .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff; /* Blue spinner */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Filter Controls - Enhanced Styling */
        .filter-controls {
            display: grid; /* Use CSS Grid for better control */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive columns */
            gap: 15px; /* Spacing between grid items */
            margin-bottom: 20px;
            justify-content: center;
            padding: 15px;
            background-color: #e9eef5;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .filter-controls .filter-group {
            display: flex;
            flex-direction: column; /* Stack label and input vertically */
        }
        .filter-controls label {
            font-weight: 600; /* Slightly less bold */
            color: #555;
            margin-bottom: 5px; /* Space between label and input */
            font-size: 0.9em; /* Slightly smaller font for labels */
        }
        .filter-controls select, .filter-controls input[type="date"], .filter-controls input[type="text"] {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em; /* Consistent font size */
            min-width: unset; /* Remove min-width to allow grid to control width */
            width: 100%; /* Take full width of its grid column */
            box-sizing: border-box; /* Include padding in width */
        }
        .filter-controls button {
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold; /* Keep bold for buttons */
            transition: background-color 0.2s ease;
            width: 100%; /* Take full width of its grid column */
            box-sizing: border-box;
        }
        .filter-controls .apply-filters-btn { /* Green for Apply */
            background-color: #28a745;
        }
        .filter-controls .apply-filters-btn:hover {
            background-color: #218838;
        }
        .filter-controls .clear-filters-btn { /* Red for Clear */
            background-color: #dc3545;
        }
        .filter-controls .clear-filters-btn:hover {
            background-color: #c82333;
        }

        .map-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            padding: 10px;
            background-color: #e0e7ed;
            border-radius: 6px;
        }
        .map-filter-controls label {
            font-weight: bold;
            color: #444;
            margin-right: 5px;
        }
        .map-filter-controls select {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85em;
        }


        /* Responsive Design for admin.html */
        @media (max-width: 1024px) {
            main {
                margin: 20px;
                padding: 20px;
                max-width: 95%; /* Adjust max-width for tablets */
            }
            .stat-box {
                max-width: 48%; /* Allow two boxes per row on tablets */
            }
            .chart-container {
                max-width: 100%;
            }
            .admin-map-container {
                max-width: 100%;
            }
            #adminDefectMap {
                height: 400px; /* Slightly smaller map on tablets */
            }
            .filter-controls {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjust columns for smaller screens */
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-controls {
                flex-direction: column;
                width: 100%;
                align-items: flex-start;
            }
            .back-to-public-btn {
                width: 100%;
            }
            .logo h1 {
                font-size: 1.5em;
            }
            .stat-box {
                max-width: 100%;
                flex-basis: 100%;
            }
            .stats-container {
                flex-direction: column;
            }
            .reports-table {
                min-width: 600px;
            }
            .reports-table th, .reports-table td {
                padding: 8px 10px;
                font-size: 0.85em;
            }
            .reports-table td img {
                max-width: 80px;
                max-height: 60px;
                object-fit: cover;
            }
            .chart-container {
                height: 300px;
            }
            #adminDefectMap {
                height: 300px;
            }
            .export-buttons button {
                width: 100%;
                margin: 5px 0;
            }
            .filter-controls {
                grid-template-columns: 1fr; /* Stack filters vertically on small mobile */
            }
            .map-filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Project Logo">
            <h1>Staff / Admin Dashboard</h1>
        </div>
        <div class="header-controls">
            <button id="backToPublicBtn" class="back-to-public-btn">← Back to 'Report Now'</button>
        </div>
    </header>

    <main id="mainContent"> <h2>Overview of Road Inspection Reports</h2>

        <div class="dashboard-section">
            <h3 id="overallSummaryHeading">
                Overall Summary
                <span class="h3-tooltip">A quick overview of all road defect reports, including active, critical, and resolved issues.</span>
            </h3>
            <div class="stats-container">
                <div class="stat-box">
                    <span class="stat-value" id="totalActiveReportsAdmin">0</span>
                    <span class="stat-label">Total Active Reports</span>
                    <span class="stat-tooltip">Number of reports that are currently open and require action.</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="criticalIssuesTodayAdmin">0</span>
                    <span class="stat-label">Critical Issues Reported Today</span>
                    <span class="stat-tooltip">Count of high-priority defects reported within the last 24 hours.</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="totalResolvedReports">0</span>
                    <span class="stat-label">Total Resolved Reports</span>
                    <span class="stat-tooltip">Cumulative number of all reports that have been successfully addressed and closed.</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="defectsByTypeChartAdmin"></canvas>
            </div>
            <p class="data-last-updated">Data last updated: <span id="lastUpdatedTimestampAdmin"></span></p>
        </div>

        <div class="dashboard-section">
            <h3>
                Detailed Breakdown
                <span class="h3-tooltip">Further analysis of reports by severity and the type of reporter (public vs. staff).</span>
            </h3>
            <div class="stats-container">
                <div class="stat-box">
                    <span class="stat-value" id="severityHigh">0</span>
                    <span class="stat-label">High Severity Defects</span>
                    <span class="stat-tooltip">Number of defects classified as high severity, indicating urgent repair needs.</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="severityMedium">0</span>
                    <span class="stat-label">Medium Severity Defects</span>
                    <span class="stat-tooltip">Number of defects classified as medium severity, requiring routine repair.</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="severityLow">0</span>
                    <span class="stat-label">Low Severity Defects</span>
                    <span class="stat-tooltip">Number of defects classified as low severity, indicating minor issues for scheduled maintenance.</span>
                </div>
            </div>
            <div class="stats-container">
                <div class="stat-box">
                    <span class="stat-value" id="reportsByPublic">0</span>
                    <span class="stat-label">Reports by Public</span>
                    <span class="stat-tooltip">Total reports submitted by the general public.</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="reportsByStaff">0</span>
                    <span class="stat-label">Reports by Staff</span>
                    <span class="stat-tooltip">Total reports submitted by authorized KeNHA personnel.</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="reportsByUnknownRole">0</span>
                    <span class="stat-label">Reports by Unknown Role</span>
                    <span class="stat-tooltip">Reports where the reporter's role could not be identified.</span>
                </div>
            </div>
            </div>

        <div class="dashboard-section admin-map-container">
            <h3>Defect Locations along KKM-Webuye-KTL (A1)Rd map</h3>
            <div class="map-filter-controls">
                <label for="filterMapDefectType">Defect Type:</label>
                <select id="filterMapDefectType">
                    <option value="">All</option>
                    <option value="Pothole">Pothole</option>
                    <option value="Crack">Crack</option>
                    <option value="Culvert Blockage">Culvert Blockage</option>
                    <option value="Shoulder Erosion">Shoulder Erosion</option>
                    <option value="Bridge Damage">Bridge Damage</option>
                    <option value="Vegetation Overgrowth">Vegetation Overgrowth</option>
                    <option value="Illegal Signpost">Illegal Signpost</option>
                    <option value="Encroachment">Encroachment</option>
                    <option value="Drainage Issue">Drainage Issue</option>
                    <option value="Road Sign Damage">Road Sign Change</option>
                    <option value="Other">Other</option>
                </select>

                <label for="filterMapSeverity">Severity:</label>
                <select id="filterMapSeverity">
                    <option value="">All</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div id="adminDefectMap"></div>
            <p id="adminMapStatus" style="margin-top: 10px; font-style: italic; color: #777;">Loading map...</p>
        </div>

        <div class="dashboard-section">
            <h3>Recent Road Inspection Reports</h3>

            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filterDefectType">Defect Type:</label>
                    <select id="filterDefectType">
                        <option value="">All</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Crack">Crack</option>
                        <option value="Culvert Blockage">Culvert Blockage</option>
                        <option value="Shoulder Erosion">Shoulder Erosion</option>
                        <option value="Bridge Damage">Bridge Damage</option>
                        <option value="Vegetation Overgrowth">Vegetation Overgrowth</option>
                        <option value="Illegal Signpost">Illegal Signpost</option>
                        <option value="Encroachment">Encroachment</option>
                        <option value="Drainage Issue">Drainage Issue</option>
                        <option value="Road Sign Damage">Road Sign Damage</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterSeverity">Severity:</label>
                    <select id="filterSeverity">
                        <option value="">All</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterStatus">Status:</label>
                    <select id="filterStatus">
                        <option value="">All</option>
                        <option value="Reported">Reported</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Deferred">Deferred</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterSubmissionType">Submission Type:</label>
                    <select id="filterSubmissionType">
                        <option value="">All</option>
                        <option value="Public User">Public User</option>
                        <option value="Staff Submission">Staff Submission</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterAssignedTeam">Assigned Team:</label>
                    <input type="text" id="filterAssignedTeam" placeholder="Filter by team name">
                </div>

                <div class="filter-group">
                    <label for="filterStartDate">From Date:</label>
                    <input type="date" id="filterStartDate">
                </div>

                <div class="filter-group">
                    <label for="filterEndDate">To Date:</label>
                    <input type="date" id="filterEndDate">
                </div>

                <button id="applyFiltersBtn" class="apply-filters-btn">Apply Filters</button>
                <button id="clearFiltersBtn" class="clear-filters-btn">Clear Filters</button>
            </div>


            <div class="reports-table-container">
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>Reporter Role</th>
                            <th>User ID</th>
                            <th>Type</th>
                            <th>Severity (User)</th>
                            <th>Location (KM Post)</th>
                            <th>Asset ID</th>
                            <th>Description</th>
                            <th>Image / Timestamp</th>
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>AI Recommendation</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="export-buttons">
            <button id="exportCsvBtn" class="export-csv-btn">Export to CSV (Excel)</button>
            <button id="exportPdfBtn" class="export-pdf-btn">Export to PDF</button> </div>

    </main>

    <div id="pdfLoadingOverlay">
        <div class="spinner"></div>
        <p>Generating PDF... Please wait.</p>
        <p>This may take a moment, especially with images and maps.</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // --- Firebase Configuration ---
        // Use the same Firebase config as your index.html
        const firebaseConfig = {
            apiKey: "AIzaSyAOQx1j1rOe2xQr7GPWgk7tj7V7pM3jfsI", // Replace with your Firebase project API Key
            authDomain: "kenha-dashboard3.firebaseapp.com",
            projectId: "kenha-dashboard3",
            storageBucket: "kenha-dashboard3.firebasestorage.app",
            messagingSenderId: "62179733586",
            appId: "1:62179733586:web:4cc76ec2895d920dcdaf8b",
            measurementId: "G-14YP9TLY05"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage(); // Needed for image URLs

        // --- Google Maps API Key (IMPORTANT: Replace this with your actual, restricted Google Maps API Key) ---
        // You MUST get this from Google Cloud Console (console.cloud.google.com)
        // 1. Enable "Maps JavaScript API", "Geocoding API", and "Geolocation API" for your project.
        // 2. Create an API key and restrict it to "HTTP referrers (web sites)".
        // 3. Add your local testing URLs (e.g., http://localhost:8080/* and file:///*)
        //    and any deployed website URLs (e.g., https://your-app.web.app/*) to the restrictions.
        //    The error "Oops! Something went wrong" strongly suggests the URL you are using to view
        //    this page is NOT authorized in your Google Maps API key restrictions.
        //    Double-check the exact URL in your browser's address bar and add it to the allowed referrers.
        const Maps_API_KEY = "AIzaSyBf9dw7PAXz1xR_tlX34hBbsYczc1vGyBE";

        // --- DOM Elements ---
        const backToPublicBtn = document.getElementById('backToPublicBtn');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const adminDefectMapDiv = document.getElementById('adminDefectMap');
        const adminMapStatus = document.getElementById('adminMapStatus');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn'); // Get the PDF button
        const pdfLoadingOverlay = document.getElementById('pdfLoadingOverlay'); // PDF loading overlay

        // Admin Dashboard Stats
        const overallSummaryHeading = document.getElementById('overallSummaryHeading'); // New: Get the h3 element
        const totalActiveReportsAdminSpan = document.getElementById('totalActiveReportsAdmin');
        const criticalIssuesTodayAdminSpan = document.getElementById('criticalIssuesTodayAdmin');
        const totalResolvedReportsSpan = document.getElementById('totalResolvedReports');
        const defectsByTypeChartAdminCtx = document.getElementById('defectsByTypeChartAdmin').getContext('2d');
        const lastUpdatedTimestampAdminSpan = document.getElementById('lastUpdatedTimestampAdmin');

        const severityHighSpan = document.getElementById('severityHigh');
        const severityMediumSpan = document.getElementById('severityMedium');
        const severityLowSpan = document.getElementById('severityLow');
        const reportsByPublicSpan = document.getElementById('reportsByPublic');
        const reportsByStaffSpan = document.getElementById('reportsByStaff');
        const reportsByUnknownRoleSpan = document.getElementById('reportsByUnknownRole');

        // Table Filter elements
        const filterDefectType = document.getElementById('filterDefectType');
        const filterSeverity = document.getElementById('filterSeverity');
        const filterStatus = document.getElementById('filterStatus');
        const filterSubmissionType = document.getElementById('filterSubmissionType'); // New filter element
        const filterAssignedTeam = document.getElementById('filterAssignedTeam');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');

        // Map Filter elements
        const filterMapDefectType = document.getElementById('filterMapDefectType');
        const filterMapSeverity = document.getElementById('filterMapSeverity');


        let adminDefectsByTypeChart; // Chart instance for admin dashboard
        let allReportsData = []; // Store all reports fetched from Firestore
        let filteredReportsData = []; // Store currently filtered reports (after table filters)
        let currentInfoWindow = null; // To keep track of the currently open InfoWindow
        let roadPolyline = null; // Declare roadPolyline here to manage its lifecycle

        // --- Utility Functions ---
        function isToday(someDate) {
            if (!someDate) return false;
            const today = new Date();
            return someDate.getDate() === today.getDate() &&
                   someDate.getMonth() === today.getMonth() &&
                   someDate.getFullYear() === today.getFullYear();
        }

        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString();
            }
            return 'N/A';
        }

        // Simple Haversine formula for distance between two lat/lng points (in km)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Simulated Chainage Calculation (KM Post) - Consistent with index.html
        // Coordinates for Kakamega MMUST Gate (KM 0 for this road segment)
        const KAKAMEGA_MMUST_LAT = 0.283;
        const KAKAMEGA_MMUST_LNG = 34.751;

        // Approximate Kitale Latitude/Longitude for the end of the road segment
        const KITALE_LAT = 1.02;
        const KITALE_LNG = 35.00;

        const TOTAL_ROAD_LENGTH_KM = 120; // Approximate length of A1 KKM-Webuye-KTL Rd (used for chainage simulation)

        function calculateChainage(currentLat, currentLng) {
            if (!currentLat || !currentLng) return 'N/A';
            const distFromKakamega = haversineDistance(KAKAMEGA_MMUST_LAT, KAKAMEGA_MMUST_LNG, currentLat, currentLng);
            let chainageKm = distFromKakamega;
            chainageKm = Math.max(0, Math.min(chainageKm, TOTAL_ROAD_LENGTH_KM));
            const km = Math.floor(chainageKm);
            const meters = Math.round((chainageKm - km) * 1000);
            return `KM ${km}+${String(meters).padStart(3, '0')}`;
        }

        /**
         * Parses a KM Post string (e.g., "KM 10+200") into a numeric kilometer value.
         * @param {string} kmPostString The KM Post string to parse.
         * @returns {number|null} The numeric kilometer value, or null if parsing fails.
         */
        function parseKmPostToKm(kmPostString) {
            if (!kmPostString || typeof kmPostString !== 'string') return null;
            const match = kmPostString.match(/KM\s*(\d+)\s*\+\s*(\d{1,3})/i); // Regex to match "KM X+YYY"
            if (match) {
                const km = parseInt(match[1], 10);
                const meters = parseInt(match[2], 10);
                return km + (meters / 1000);
            }
            // Fallback for cases where it might just be a number string
            const num = parseFloat(kmPostString);
            if (!isNaN(num)) return num;
            return null;
        }


        // AI Simulation Function - Enhanced for clearer criteria and impact (Consistent with index.html)
        function simulateAIAnalysis(report) {
            let severity = 'Medium';
            let recommendation = 'Standard maintenance required. Estimated cost: KES 20,000.';

            const lowerDescription = (report.description || '').toLowerCase();
            const lowerDefectType = (report.defectType || '').toLowerCase();
            const userSeverity = report.severityLevel; // User's selected severity

            // Prioritize user's manual severity if provided and valid
            if (userSeverity && ['Critical', 'High', 'Medium', 'Low'].includes(userSeverity)) {
                severity = userSeverity;
            }

            // AI analysis based on keywords and defect types
            if (lowerDescription.includes('large pothole') || lowerDescription.includes('collapsed culvert') || lowerDescription.includes('severe crack') || lowerDescription.includes('impassable') || lowerDescription.includes('accident prone') || lowerDefectType === 'bridge damage') {
                severity = 'Critical';
                recommendation = 'Immediate attention required: severe hazard, potential road closure. Estimated cost: KES 500,000+.';
            } else if (lowerDescription.includes('significant crack') || lowerDescription.includes('major blockage') || lowerDescription.includes('medium pothole') || lowerDescription.includes('dangerous') || lowerDefectType === 'culvert blockage' || lowerDefectType === 'encroachment') {
                if (severity !== 'Critical') severity = 'High'; // Don't downgrade from Critical
                recommendation = 'Urgent repair needed, schedule within 1-3 days. Significant hazard. Estimated cost: KES 100,000 - 500,000.';
            } else if (lowerDescription.includes('small crack') || lowerDescription.includes('minor erosion') || lowerDescription.includes('bushes') || lowerDescription.includes('overgrowth') || lowerDefectType === 'shoulder erosion' || lowerDefectType === 'illegal signpost' || lowerDefectType === 'drainage issue' || lowerDefectType === 'road sign damage') {
                if (severity !== 'Critical' && severity !== 'High') severity = 'Medium'; // Don't downgrade from higher
                recommendation = 'Routine maintenance required, address within 1-2 weeks. Minor hazard. Estimated cost: KES 20,000 - 100,000.';
            } else {
                if (severity !== 'Critical' && severity !== 'High' && severity !== 'Medium') severity = 'Low'; // Don't downgrade from higher
                recommendation = 'Add to routine inspection/maintenance schedule. Minimal immediate impact. Estimated cost: KES <20,000.';
            }

            // Refine recommendations based on specific defect types if not already high severity
            if (lowerDefectType === 'encroachment' && severity !== 'Critical' && severity !== 'High') {
                severity = 'High';
                recommendation = 'Notify legal and enforcement team for immediate action. Document thoroughly. Estimated cost: Legal/removal fees.';
            } else if (lowerDefectType === 'illegal signpost' && severity !== 'Critical' && severity !== 'High') {
                severity = 'Medium';
                recommendation = 'Dispatch team for signpost removal and fine assessment. Estimated cost: Removal fees.';
            } else if (lowerDefectType === 'culvert blockage' && severity !== 'Critical') {
                severity = 'High';
                recommendation = 'Urgent clearing of debris to prevent flooding/road damage. Estimated cost: KES 50,000 - 200,000.';
            } else if (lowerDefectType === 'pothole' && severity === 'Medium') {
                recommendation = 'Patching required within a week. Estimated cost: KES 20,000 - 50,000 per pothole.';
            } else if (lowerDefectType === 'shoulder erosion' && severity === 'Medium') {
                recommendation = 'Resurfacing or gabion placement recommended. Estimated cost: KES 30,000 - 150,000.';
            }

            return { severity, recommendation };
        }

        // --- Google Maps Integration for Admin Dashboard ---
        let adminMap = null; // To store the admin Google Map instance
        let adminMapMarkers = []; // To store markers for clearing

        // Define a more detailed path for the KKM–Webuye–KTL Rd
        const kkmWebuyeKtlRoadPath = [
            { lat: 0.283, lng: 34.751 }, // Kakamega (approx)
            { lat: 0.35, lng: 34.755 },  // North of Kakamega, towards Webuye
            { lat: 0.45, lng: 34.76 },   // Further north
            { lat: 0.55, lng: 34.74 },   // Approaching Webuye
            { lat: 0.58, lng: 34.70 },   // Webuye (approx)
            { lat: 0.65, lng: 34.75 },   // Towards Kitale
            { lat: 0.80, lng: 34.85 },   // Mid-point to Kitale
            { lat: 0.90, lng: 34.90 },   // Closer to Kitale
            { lat: 1.02, lng: 35.00 }    // Kitale (approx)
        ];

        function loadGoogleMapsScript(callback) {
            if (window.google && window.google.maps) {
                callback();
                return;
            }
            if (document.getElementById('googleMapsScriptAdmin')) {
                window.initAdminMapPlaceholder = callback;
                return;
            }
            const script = document.createElement('script');
            script.id = 'googleMapsScriptAdmin';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}&callback=initAdminMapPlaceholder`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);

            window.initAdminMapPlaceholder = callback; // Global callback for Google Maps
            script.onerror = () => {
                console.error("Failed to load Google Maps JavaScript API script for admin dashboard.");
                adminMapStatus.textContent = "Error loading map. Check API key and console for details.";
                adminDefectMapDiv.innerHTML = "<p style='color:red;'>Error loading map. Please ensure your API key is correct and authorized for this domain.</p>";
            };
        }

        function displayAdminDefectMap(reports) {
            if (!window.google || !window.google.maps) {
                console.error("Google Maps API not loaded when trying to display admin map.");
                adminDefectMapDiv.innerHTML = "<p style='color:red;'>Map API not ready. Please try refreshing the page.</p>";
                adminMapStatus.textContent = "Map unavailable.";
                return;
            }

            // Clear existing markers
            adminMapMarkers.forEach(marker => marker.setMap(null));
            adminMapMarkers = [];

            // Close any open info window when re-displaying map data
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }

            // Apply map-specific filters on the reports passed in (which are already table-filtered)
            let reportsToMap = [...reports]; // Clone to avoid modifying the original filteredReportsData
            const mapTypeFilter = filterMapDefectType.value;
            const mapSeverityFilter = filterMapSeverity.value;

            if (mapTypeFilter) {
                reportsToMap = reportsToMap.filter(report => report.defectType === mapTypeFilter);
            }
            if (mapSeverityFilter) {
                reportsToMap = reportsToMap.filter(report => (report.severityLevel === mapSeverityFilter || report.aiSeverity === mapSeverityFilter));
            }

            const reportsWithLocation = reportsToMap.filter(r => r.latitude && r.longitude);

            // Create a LatLngBounds object to encompass all markers AND the road polyline
            const bounds = new google.maps.LatLngBounds();
            kkmWebuyeKtlRoadPath.forEach(coord => bounds.extend(coord)); // Extend bounds for the road

            // Extend bounds with report locations if any
            reportsWithLocation.forEach(r => bounds.extend({ lat: r.latitude, lng: r.longitude }));

            if (!adminMap) {
                adminMap = new google.maps.Map(adminDefectMapDiv, {
                    center: bounds.getCenter(), // Initial center based on road and markers
                    zoom: 10, // Default zoom, will be overridden by fitBounds
                    mapTypeId: 'roadmap',
                    fullscreenControl: true,
                    streetViewControl: false,
                    mapTypeControl: true,
                    zoomControl: true,
                });
                adminMap.addListener('click', () => {
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                        currentInfoWindow = null;
                    }
                });
            }

            // Always fit bounds to ensure road and markers are visible
            adminMap.fitBounds(bounds);
            // Optionally, if you want a bit more padding around the bounds:
            // adminMap.fitBounds(bounds, { padding: 50 });


            adminMapStatus.textContent = `Displaying ${reportsWithLocation.length} reports with location data.` + (reportsToMap.length - reportsWithLocation.length > 0 ? ` (${reportsToMap.length - reportsWithLocation.length} reports without location data)` : '');

            // Draw the road polyline
            if (roadPolyline) {
                roadPolyline.setMap(null); // Remove old polyline if exists
            }
            roadPolyline = new google.maps.Polyline({
                path: kkmWebuyeKtlRoadPath,
                geodesic: true,
                strokeColor: '#1A73E8', // A distinct, vibrant blue
                strokeOpacity: 0.9,
                strokeWeight: 8, // Thicker line
                map: adminMap,
                title: 'KKM–Webuye–KTL Road Corridor' // Tooltip for the polyline
            });

            // Add a simple InfoWindow for the polyline on click (optional, but good for UX)
            roadPolyline.addListener('click', (event) => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
                const roadInfoWindow = new google.maps.InfoWindow({
                    content: '<div style="font-family: \'Segoe UI\', sans-serif; padding: 5px;"><strong>KKM–Webuye–KTL Road Corridor</strong><br>Main inspection route.</div>',
                    position: event.latLng // Show info window at click location
                });
                roadInfoWindow.open(adminMap);
                currentInfoWindow = roadInfoWindow;
            });


            const infoWindow = new google.maps.InfoWindow(); // Single info window for markers

            reportsWithLocation.forEach(report => {
                let markerColor = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; // Default to red
                if (report.aiSeverity === 'Critical') {
                    markerColor = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
                } else if (report.aiSeverity === 'High') {
                    markerColor = 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png';
                } else if (report.aiSeverity === 'Medium') {
                    markerColor = 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
                } else if (report.aiSeverity === 'Low') {
                    markerColor = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
                }

                const marker = new google.maps.Marker({
                    position: { lat: report.latitude, lng: report.longitude },
                    map: adminMap,
                    title: `${report.defectType} at ${report.kilometerPost}`,
                    icon: markerColor, // Set marker color based on severity
                    animation: google.maps.Animation.DROP,
                });

                // Store marker on the report object for easy retrieval
                report.marker = marker;

                const infoWindowContent = `
                    <div style="font-family: 'Segoe UI', sans-serif; padding: 5px; position: relative;">
                        <span class="close-info-window" style="position: absolute; top: 5px; right: 5px; cursor: pointer; font-weight: bold; color: #dc3545; font-size: 1.2em;">×</span>
                        <strong>${report.defectType}</strong><br>
                        Severity: ${report.severityLevel || 'N/A'}<br>
                        Location: ${report.kilometerPost}<br>
                        ${report.distFromKakamega !== null ? `Distance from KM 0 (Kakamega MMUST Gate): <strong>${report.distFromKakamega.toFixed(2)} km</strong><br>` : ''}
                        Description: ${report.description ? report.description.substring(0, 100) + (report.description.length > 100 ? '...' : '') : 'N/A'}<br>
                        Status: ${report.status}<br>
                        Assigned To: ${report.assignedTeam || 'Unassigned'}<br>
                        ${report.imageUrl ? `<img src="${report.imageUrl}" style="max-width:100px; max-height:80px; margin-top:5px; border-radius:4px;">` : ''}
                    </div>
                `;

                marker.addListener('click', () => {
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(adminMap, marker);
                    currentInfoWindow = infoWindow; // Set the current open info window

                    // Add event listener to the close button within the info window content
                    google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                        const closeButton = adminDefectMapDiv.querySelector('.close-info-window');
                        if (closeButton) {
                            closeButton.addEventListener('click', () => {
                                infoWindow.close();
                                currentInfoWindow = null;
                            });
                        }
                    });
                });
                adminMapMarkers.push(marker);
            });
        }

        // --- Data Fetching and Dashboard Update ---
        document.addEventListener('DOMContentLoaded', () => {
            loadGoogleMapsScript(() => {
                console.log("Google Maps API loaded for admin dashboard.");
                fetchReportsAndUpdateDashboard();
            });

            backToPublicBtn.addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            exportCsvBtn.addEventListener('click', exportReportsToCsv);
            exportPdfBtn.addEventListener('click', exportReportsToPdf);

            applyFiltersBtn.addEventListener('click', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);

            // Add event listeners for new map filters
            filterMapDefectType.addEventListener('change', () => displayAdminDefectMap(filteredReportsData));
            filterMapSeverity.addEventListener('change', () => displayAdminDefectMap(filteredReportsData));
        });


        function fetchReportsAndUpdateDashboard() {
            db.collection('reports').orderBy('timestamp', 'desc')
                .onSnapshot((snapshot) => {
                    allReportsData = [];
                    snapshot.forEach(doc => {
                        const reportData = doc.data();

                        let calculatedDistance = null;

                        // Priority 1: If manual KM Post is provided and parseable, use it for distance
                        const parsedKm = parseKmPostToKm(reportData.kilometerPost);
                        if (parsedKm !== null) {
                            calculatedDistance = parsedKm;
                        }
                        // Priority 2: If no parseable KM Post, but lat/lng are available, use haversine
                        else if (reportData.latitude && reportData.longitude) {
                            calculatedDistance = haversineDistance(KAKAMEGA_MMUST_LAT, KAKAMEGA_MMUST_LNG, reportData.latitude, reportData.longitude);
                        }

                        reportData.distFromKakamega = calculatedDistance;
                        allReportsData.push({ id: doc.id, ...reportData });
                    });
                    applyFilters(); // Apply filters on initial load and subsequent data changes
                }, (error) => {
                    console.error("Error fetching real-time reports:", error);
                    adminMapStatus.textContent = "Error loading map data.";
                });
        }

        function applyFilters() {
            let tempReports = [...allReportsData]; // Start with all data

            const typeFilter = filterDefectType.value;
            const severityFilter = filterSeverity.value;
            const statusFilter = filterStatus.value;
            const submissionTypeFilter = filterSubmissionType.value; // Get value of new filter
            const assignedTeamFilter = filterAssignedTeam.value.toLowerCase();
            const startDateFilter = filterStartDate.value ? new Date(filterStartDate.value) : null;
            const endDateFilter = filterEndDate.value ? new Date(endDateFilter.value) : null;

            if (typeFilter) {
                tempReports = tempReports.filter(report => report.defectType === typeFilter);
            }
            if (severityFilter) {
                tempReports = tempReports.filter(report => (report.severityLevel === severityFilter || report.aiSeverity === severityFilter));
            }
            if (statusFilter) {
                tempReports = tempReports.filter(report => report.status === statusFilter);
            }
            // Apply new submission type filter
            if (submissionTypeFilter) {
                tempReports = tempReports.filter(report => {
                    const isPublicUser = report.reporterRole === 'Public User' || (!report.reporterRole && !report.staffName && !report.staffRole);
                    const isStaffSubmission = (report.reporterRole && report.reporterRole !== 'Public User' && report.reporterRole !== 'Unknown') || (report.staffName || report.staffRole);

                    if (submissionTypeFilter === 'Public User') {
                        return isPublicUser;
                    } else if (submissionTypeFilter === 'Staff Submission') {
                        return isStaffSubmission;
                    }
                    return true; // Should not happen with current options, but good for safety
                });
            }

            if (assignedTeamFilter) {
                tempReports = tempReports.filter(report => (report.assignedTeam || '').toLowerCase().includes(assignedTeamFilter));
            }
            if (startDateFilter) {
                tempReports = tempReports.filter(report => report.timestamp && report.timestamp.toDate() >= startDateFilter);
            }
            if (endDateFilter) {
                tempReports = tempReports.filter(report => report.timestamp && report.timestamp.toDate() <= endDateFilter);
            }

            filteredReportsData = tempReports; // Update filtered data
            updateAdminDashboard(filteredReportsData);
            populateReportsTable(filteredReportsData);
            displayAdminDefectMap(filteredReportsData); // Call map update with the newly filtered data
        }

        function clearFilters() {
            filterDefectType.value = '';
            filterSeverity.value = '';
            filterStatus.value = '';
            filterSubmissionType.value = ''; // Clear new filter
            filterAssignedTeam.value = '';
            filterStartDate.value = '';
            filterEndDate.value = '';

            // Also clear map specific filters when main filters are cleared
            filterMapDefectType.value = '';
            filterMapSeverity.value = '';

            applyFilters(); // Re-apply filters to show all data
        }


        function updateAdminDashboard(reports) {
            let totalActive = reports.filter(r => r.status !== 'Resolved' && r.status !== 'Deferred').length;
            let criticalToday = reports.filter(r => r.aiSeverity === 'Critical' && r.timestamp && isToday(r.timestamp.toDate())).length;
            let totalResolved = reports.filter(r => r.status === 'Resolved').length;

            totalActiveReportsAdminSpan.textContent = totalActive;
            criticalIssuesTodayAdminSpan.textContent = criticalToday;
            totalResolvedReportsSpan.textContent = totalResolved;
            lastUpdatedTimestampAdminSpan.textContent = new Date().toLocaleString();

            const defectCounts = {};
            reports.forEach(report => {
                const type = report.defectType || 'Unknown';
                defectCounts[type] = (defectCounts[type] || 0) + 1;
            });
            const chartLabels = Object.keys(defectCounts);
            const chartData = Object.values(defectCounts);

            if (adminDefectsByTypeChart) {
                adminDefectsByTypeChart.data.labels = chartLabels;
                adminDefectsByTypeChart.data.datasets[0].data = chartData;
                adminDefectsByTypeChart.update();
            } else {
                adminDefectsByTypeChart = new Chart(defectsByTypeChartAdminCtx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9900', '#A52A2A', '#008000', '#6A5ACD', '#DAA520'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', align: 'center', labels: { font: { size: 12 } } },
                            title: { display: true, text: 'Defects by Type (Cumulative)', font: { size: 16 } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        label += context.parsed + ' reports (' + ((context.parsed / chartData.reduce((a,b)=>a+b,0)) * 100).toFixed(1) + '%)';
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update "Overall Summary" heading based on filters
            let headingText = 'Overall Summary';
            if (filterDefectType.value) {
                headingText += ` for ${filterDefectType.value} Reports`;
            }
            overallSummaryHeading.textContent = headingText;


            // Detailed Breakdown Stats
            let highSeverity = reports.filter(r => r.aiSeverity === 'High' || r.severityLevel === 'High').length;
            let mediumSeverity = reports.filter(r => r.aiSeverity === 'Medium' || r.severityLevel === 'Medium').length;
            let lowSeverity = reports.filter(r => r.aiSeverity === 'Low' || r.severityLevel === 'Low').length;

            severityHighSpan.textContent = highSeverity;
            severityMediumSpan.textContent = mediumSeverity;
            severityLowSpan.textContent = lowSeverity;

            // Updated logic for dashboard stats to reflect new role handling
            let publicReports = reports.filter(r => {
                const role = r.reporterRole;
                return role === 'Public User' || (!role && !r.staffName && !r.staffRole);
            }).length;

            let staffReports = reports.filter(r => {
                const role = r.reporterRole;
                return (role && role !== 'Public User' && role !== 'Unknown') || (r.staffName || r.staffRole);
            }).length;

            let unknownRoleReports = reports.filter(r => {
                const role = r.reporterRole;
                return role === 'Unknown'; // Only count 'Unknown' if it's explicitly set as such
            }).length;

            reportsByPublicSpan.textContent = publicReports;
            reportsByStaffSpan.textContent = staffReports;
            reportsByUnknownRoleSpan.textContent = unknownRoleReports;
        }

        function populateReportsTable(reports) {
            reportsTableBody.innerHTML = ''; // Clear existing rows

            reports.forEach(report => {
                const row = reportsTableBody.insertRow();
                row.dataset.reportId = report.id; // Store report ID for updates

                // Determine the display string for Reporter Role based on new logic
                let displayReporterRole;
                if (report.reporterRole && report.reporterRole !== 'Unknown' && report.reporterRole !== 'Public') {
                    // If reporterRole has a value and it's not 'Unknown' or 'Public', use it directly (e.g., 'Surveyor', 'Asst Eng')
                    displayReporterRole = report.reporterRole;
                } else if (report.staffName || report.staffRole) {
                    // If reporterRole is 'Unknown', 'Public', or falsy, but staffName/staffRole exist, it's a staff submission
                    displayReporterRole = 'Staff User (Role Not Provided)';
                } else {
                    // Otherwise (reporterRole is 'Unknown', 'Public', or falsy, AND no staff info), default to Public User
                    displayReporterRole = 'Public User';
                }
                row.insertCell().textContent = displayReporterRole; // Reporter Role

                row.insertCell().textContent = report.userId || 'N/A'; // User ID
                row.insertCell().textContent = report.defectType || 'N/A'; // Type
                // Removed AI Severity column
                row.insertCell().textContent = report.severityLevel || 'N/A'; // User Severity

                // Location (KM Post) with Lat/Lng in brackets
                const kmPostCell = row.insertCell();
                kmPostCell.textContent = report.kilometerPost || calculateChainage(report.latitude, report.longitude) || 'N/A';
                if (report.latitude && report.longitude) {
                    const latLngDiv = document.createElement('div');
                    latLngDiv.style.fontSize = '0.75em';
                    latLngDiv.style.color = '#777';
                    latLngDiv.textContent = `(${report.latitude.toFixed(6)}, ${report.longitude.toFixed(6)})`;
                    kmPostCell.appendChild(latLngDiv);
                }

                row.insertCell().textContent = report.assetId || 'N/A'; // Asset ID
                row.insertCell().textContent = report.description ? report.description.substring(0, 100) + (report.description.length > 100 ? '...' : '') : 'N/A'; // Message (truncated)

                // Image / Timestamp column
                const imgTimestampCell = row.insertCell();
                // Add click listener to the cell to pan map
                imgTimestampCell.style.cursor = 'pointer'; // Indicate clickability
                imgTimestampCell.addEventListener('click', () => {
                    if (report.marker && adminMap) {
                        adminMap.panTo(report.marker.getPosition());
                        // Scroll the page to the map section
                        adminDefectMapDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        // Manually trigger info window content and open
                        const infoWindowContent = `
                            <div style="font-family: 'Segoe UI', sans-serif; padding: 5px; position: relative;">
                                <span class="close-info-window" style="position: absolute; top: 5px; right: 5px; cursor: pointer; font-weight: bold; color: #dc3545; font-size: 1.2em;">×</span>
                                <strong>${report.defectType}</strong><br>
                                Severity: ${report.severityLevel || 'N/A'}<br>
                                Location: ${report.kilometerPost}<br>
                                ${report.distFromKakamega !== null ? `Distance from KM 0 (Kakamega MMUST Gate): <strong>${report.distFromKakamega.toFixed(2)} km</strong><br>` : ''}
                                Description: ${report.description ? report.description.substring(0, 100) + (report.description.length > 100 ? '...' : '') : 'N/A'}<br>
                                Status: ${report.status}<br>
                                Assigned To: ${report.assignedTeam || 'Unassigned'}<br>
                                ${report.imageUrl ? `<img src="${report.imageUrl}" style="max-width:100px; max-height:80px; margin-top:5px; border-radius:4px;">` : ''}
                            </div>
                        `;
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        const tempInfoWindow = new google.maps.InfoWindow({
                            content: infoWindowContent,
                            position: report.marker.getPosition()
                        });
                        tempInfoWindow.open(adminMap);
                        currentInfoWindow = tempInfoWindow; // Set the current open info window

                        // Add event listener to the close button within the info window content
                        google.maps.event.addListenerOnce(currentInfoWindow, 'domready', () => {
                            const closeButton = adminDefectMapDiv.querySelector('.close-info-window');
                            if (closeButton) {
                                closeButton.addEventListener('click', () => {
                                    currentInfoWindow.close();
                                    currentInfoWindow = null;
                                });
                            }
                        });
                    }
                });

                if (report.imageUrl) {
                    const img = document.createElement('img');
                    img.src = report.imageUrl;
                    img.alt = 'Defect Image';
                    img.onerror = function() { this.src = 'https://placehold.co/100x80/cccccc/ffffff?text=No+Image'; }; // Fallback image
                    imgTimestampCell.appendChild(img);
                } else {
                    imgTimestampCell.innerHTML = 'No Image';
                }
                const timestampDiv = document.createElement('div');
                timestampDiv.style.fontSize = '0.8em';
                timestampDiv.style.color = '#555';
                timestampDiv.textContent = formatTimestamp(report.timestamp);
                imgTimestampCell.appendChild(timestampDiv);


                // Status dropdown
                const statusCell = row.insertCell();
                const statusDropdown = document.createElement('select');
                statusDropdown.classList.add('editable-select'); // Use the new class
                const statuses = ['Reported', 'In Progress', 'Resolved', 'Deferred'];
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === (report.status || 'Reported')) {
                        option.selected = true;
                    }
                    statusDropdown.appendChild(option);
                });
                statusCell.appendChild(statusDropdown);
                statusCell.classList.add(`status-${(report.status || 'Reported').toLowerCase().replace(/\s/g, '-')}`); // Add class for styling

                // Add event listener to update Firestore on status change
                statusDropdown.addEventListener('change', async (event) => {
                    const newStatus = event.target.value;
                    try {
                        await db.collection('reports').doc(report.id).update({ status: newStatus });
                        // Update the class for styling immediately
                        statusCell.className = ''; // Clear existing classes
                        statusCell.classList.add(`status-${newStatus.toLowerCase().replace(/\s/g, '-')}`);
                        console.log(`Report ${report.id} status updated to ${newStatus}`);
                        // No need to re-fetch all reports, onSnapshot will handle it
                    } catch (error) {
                        console.error("Error updating document status:", error);
                        alert("Failed to update status. Please try again.");
                    }
                });


                row.insertCell().textContent = report.assignedTeam || 'Unassigned'; // Assigned To
                row.insertCell().textContent = report.aiRecommendation || 'N/A'; // AI Analysis
            });
        }

        // --- Export Functions ---
        function exportReportsToCsv() {
            if (allReportsData.length === 0) {
                alert("No data to export!");
                return;
            }

            const headers = [
                "Reporter Role", "User ID", "Type", "Severity", "Location (KM Post)", "Latitude", "Longitude", "Asset ID",
                "Description", "Image URL", "Timestamp", "Status", "Assigned To", "AI Recommendation", "Distance from KM 0 (km)"
            ];

            const rows = allReportsData.map(report => {
                // Determine the display string for Reporter Role for CSV export
                let csvReporterRole;
                if (report.reporterRole && report.reporterRole !== 'Unknown' && report.reporterRole !== 'Public') {
                    csvReporterRole = report.reporterRole;
                } else if (report.staffName || report.staffRole) {
                    csvReporterRole = 'Staff User (Role Not Provided)';
                } else {
                    csvReporterRole = 'Public User';
                }

                return [
                    csvReporterRole,
                    report.userId || 'N/A',
                    report.defectType || 'N/A',
                    report.severityLevel || report.aiSeverity || 'N/A', // Use AI severity if user severity is missing
                    report.kilometerPost || 'N/A',
                    report.latitude !== null ? report.latitude.toFixed(6) : 'N/A',
                    report.longitude !== null ? report.longitude.toFixed(6) : 'N/A',
                    report.assetId || 'N/A',
                    `"${(report.description || '').replace(/"/g, '""')}"`, // Handle commas/quotes in description
                    report.imageUrl || 'N/A',
                    formatTimestamp(report.timestamp),
                    report.status || 'Reported',
                    report.assignedTeam || 'Unassigned',
                    `"${(report.aiRecommendation || '').replace(/"/g, '""')}"`,
                    report.distFromKakamega !== null ? report.distFromKakamega.toFixed(2) : 'N/A'
                ];
            });

            let csvContent = headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'KeNHA_Reports.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Reports exported to CSV!");
        }

        // Function to export reports to PDF
        function exportReportsToPdf() {
            const element = document.getElementById('mainContent'); // Target the main content area

            if (!element) {
                alert("Error: Could not find content to export to PDF.");
                console.error("Element with ID 'mainContent' not found.");
                return;
            }

            // Show loading overlay
            pdfLoadingOverlay.classList.add('visible');

            // Options for PDF generation
            const options = {
                margin: 10,
                filename: 'KeNHA_Admin_Dashboard_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2, // Higher scale for better quality
                    useCORS: true, // Important for images loaded from different origins (like Firebase Storage)
                    // Added a short delay for html2canvas to ensure all images and elements are rendered
                    // This is a common workaround for blank PDFs with dynamic content/images.
                    // If still blank, try increasing this delay.
                    onrendered: function(canvas) {
                        // Optional: You can do something with the canvas here before PDF generation
                    }
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Use html2pdf to generate and download the PDF
            // The promise ensures the overlay is hidden after generation
            html2pdf().set(options).from(element).save().then(() => {
                pdfLoadingOverlay.classList.remove('visible'); // Hide overlay after PDF is generated
            }).catch(error => {
                console.error("PDF generation failed:", error);
                alert("Failed to generate PDF. Please check console for details.");
                pdfLoadingOverlay.classList.remove('visible'); // Hide overlay on error
            });
        }
    </script>
</body>
</html>
